import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, Play, Trash2, Clock, ChevronRight, ChevronLeft, 
  Settings2, X, Cloud, RefreshCw, ShieldAlert, Dumbbell 
} from 'lucide-react';

const App = () => {
  // --- State ---
  const [view, setView] = useState('home'); 
  const [routines, setRoutines] = useState([]);
  const [activeRoutine, setActiveRoutine] = useState(null);
  const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
  const [workoutLog, setWorkoutLog] = useState({});
  
  // Timer State
  const [timerActive, setTimerActive] = useState(false);
  const [timeLeft, setTimeLeft] = useState(0);
  const [targetEndTime, setTargetEndTime] = useState(null);
  
  // Notion State
  const [notionKey, setNotionKey] = useState(localStorage.getItem('notion_key') || '');
  const [notionDbId, setNotionDbId] = useState(localStorage.getItem('notion_db_id') || '');
  const [notionExercises, setNotionExercises] = useState([]);
  const [syncStatus, setSyncStatus] = useState('idle');
  const [errorMessage, setErrorMessage] = useState('');

  const timerRef = useRef(null);

  // --- Persistence ---
  useEffect(() => {
    const saved = localStorage.getItem('gym_routines');
    if (saved) setRoutines(JSON.parse(saved));
    const savedEx = localStorage.getItem('notion_exercises_cache');
    if (savedEx) setNotionExercises(JSON.parse(savedEx));
  }, []);

  useEffect(() => {
    localStorage.setItem('gym_routines', JSON.stringify(routines));
  }, [routines]);

  useEffect(() => {
    localStorage.setItem('notion_key', notionKey);
    localStorage.setItem('notion_db_id', notionDbId);
  }, [notionKey, notionDbId]);

  // --- Notion Logic ---
  const fetchExercisesFromNotion = async () => {
    if (!notionKey || !notionDbId) {
      setErrorMessage("Missing Key or ID.");
      setSyncStatus('error');
      return;
    }
    setSyncStatus('syncing');
    setErrorMessage('');
    
    try {
      const proxyUrl = "https://cors-anywhere.herokuapp.com/"; 
      const apiUrl = `https://api.notion.com/v1/databases/${notionDbId}/query`;
      
      const response = await fetch(proxyUrl + apiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${notionKey}`,
          'Notion-Version': '2022-06-28',
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          filter: { property: "Routine", select: { is_not_empty: true } }
        })
      });

      if (response.status === 403) throw new Error("Proxy access expired. Re-activate at cors-anywhere.herokuapp.com/corsdemo");
      if (!response.ok) throw new Error("Notion rejected the request. Check API key permissions.");
      
      const data = await response.json();
      const fetched = data.results.map(page => {
        const props = page.properties;
        return {
          id: page.id,
          name: props["Exercise Name"]?.title?.[0]?.plain_text || "Untitled",
          tag: props["Routine"]?.select?.name || "",
          // Fetching Sets and Pause (Rest) from your columns
          sets: props["Sets"]?.number || 3,
          pause: props["Pause"]?.number || 90
        };
      }).filter(ex => ex.name !== "Untitled");
      
      setNotionExercises(fetched);
      localStorage.setItem('notion_exercises_cache', JSON.stringify(fetched));
      setSyncStatus('success');
      setTimeout(() => setSyncStatus('idle'), 3000);
    } catch (err) {
      setErrorMessage(err.message);
      setSyncStatus('error');
    }
  };

  // --- Timer Logic ---
  useEffect(() => {
    if (timerActive && targetEndTime) {
      timerRef.current = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(0, Math.ceil((targetEndTime - now) / 1000));
        setTimeLeft(remaining);
        if (remaining <= 0) {
          setTimerActive(false);
          setTargetEndTime(null);
          clearInterval(timerRef.current);
        }
      }, 500);
    }
    return () => clearInterval(timerRef.current);
  }, [timerActive, targetEndTime]);

  const startTimer = (seconds) => {
    const end = Date.now() + (seconds * 1000);
    setTargetEndTime(end);
    setTimeLeft(seconds);
    setTimerActive(true);
  };

  // --- App Actions ---
  const addExerciseToRoutine = (exObj) => {
    const updated = { ...activeRoutine };
    updated.exercises.push({ 
      id: Math.random().toString(36).substr(2, 9), 
      name: exObj.name, 
      defaultPause: exObj.pause || 90, 
      targetSets: exObj.sets || 3 
    });
    setActiveRoutine(updated);
  };

  const logSet = (exerciseId, weight, reps, pause) => {
    const log = { ...workoutLog };
    if (!log[exerciseId]) log[exerciseId] = [];
    log[exerciseId].push({ weight, reps, timestamp: new Date() });
    setWorkoutLog(log);
    startTimer(pause);
  };

  // --- Components ---
  const Header = ({ title, subtitle }) => (
    <header className="bg-white/80 backdrop-blur-md border-b border-slate-100 pt-12 pb-4 px-6 sticky top-0 z-50 flex justify-between items-end">
      <div>
        <h1 className="text-xl font-bold text-slate-900 tracking-tight">{title}</h1>
        {subtitle && <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">{subtitle}</p>}
      </div>
      <button onClick={() => setView(view === 'home' ? 'settings' : 'home')} className="p-2.5 bg-slate-50 text-slate-400 rounded-full active:bg-slate-100 transition-colors">
        {view === 'home' ? <Settings2 size={18} /> : <X size={18} />}
      </button>
    </header>
  );

  // --- Views ---
  if (view === 'settings') {
    return (
      <div className="min-h-screen bg-white pb-20">
        <Header title="Settings" subtitle="Cloud Sync" />
        <main className="p-6 space-y-4">
          <div className="p-5 rounded-3xl bg-slate-50 border border-slate-100 space-y-4">
            <div>
              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block ml-1">Notion Secret</label>
              <input type="password" value={notionKey} onChange={(e) => setNotionKey(e.target.value)} className="w-full p-3 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500" />
            </div>
            <div>
              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block ml-1">Database ID</label>
              <input type="text" value={notionDbId} onChange={(e) => setNotionDbId(e.target.value)} className="w-full p-3 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500" />
            </div>
          </div>
          <button onClick={fetchExercisesFromNotion} disabled={syncStatus === 'syncing'} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-[0.98] transition-all disabled:opacity-50">
            {syncStatus === 'syncing' ? <RefreshCw className="animate-spin" size={18} /> : 'Refresh Library'}
          </button>
          {syncStatus === 'error' && (
            <div className="p-4 bg-red-50 rounded-2xl border border-red-100 text-center">
              <p className="text-[11px] text-red-500 font-semibold">{errorMessage}</p>
              {errorMessage.includes("Proxy") && <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="text-[10px] text-red-600 underline font-bold mt-2 block">Activate Proxy Access</a>}
            </div>
          )}
        </main>
      </div>
    );
  }

  if (view === 'home') {
    return (
      <div className="min-h-screen bg-white">
        <Header title="Protocols" subtitle="Active Routines" />
        <main className="p-6 space-y-3 pb-32">
          {routines.map(r => (
            <div key={r.id} className="p-5 rounded-[28px] bg-slate-50 border border-slate-100 flex items-center justify-between shadow-sm">
              <div>
                <h3 className="font-bold text-slate-900">{r.name}</h3>
                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{r.exercises.length} Exercises</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => { setActiveRoutine(r); setView('planner'); }} className="p-3 text-slate-300 active:text-slate-600"><Settings2 size={18}/></button>
                <button onClick={() => startWorkout(r)} className="w-11 h-11 bg-blue-600 text-white rounded-xl flex items-center justify-center active:scale-90 transition-transform"><Play size={18} fill="currentColor" /></button>
              </div>
            </div>
          ))}
          <button onClick={() => { const nr = {id:Date.now(), name:"New Routine", exercises:[]}; setRoutines([...routines, nr]); setActiveRoutine(nr); setView('planner'); }} className="w-full py-8 border-2 border-dashed border-slate-200 rounded-[28px] text-slate-300 flex flex-col items-center gap-1 active:bg-slate-50">
            <Plus size={20} />
            <span className="text-[10px] font-black uppercase tracking-widest">Create Routine</span>
          </button>
        </main>
      </div>
    );
  }

  if (view === 'planner') {
    return (
      <div className="min-h-screen bg-white">
        <Header title="Edit Protocol" subtitle="Library Sync Active" />
        <main className="p-5 space-y-6 pb-40">
          <input value={activeRoutine.name} onChange={(e) => setActiveRoutine({...activeRoutine, name: e.target.value})} className="text-2xl font-bold text-slate-900 border-none outline-none w-full" placeholder="Routine Name" />
          
          <div className="space-y-3">
            <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Quick Add From Library</h4>
            <div className="flex flex-wrap gap-2">
              {notionExercises.map((ex, i) => (
                <button key={i} onClick={() => addExerciseToRoutine(ex)} className="px-3 py-1.5 bg-slate-50 border border-slate-100 rounded-lg text-[11px] font-bold text-slate-600 active:bg-blue-600 active:text-white flex items-center gap-1.5">
                  <span className="opacity-40 text-[9px] px-1 bg-slate-200 rounded">{ex.tag}</span> {ex.name}
                </button>
              ))}
            </div>
          </div>

          <div className="space-y-3">
            {activeRoutine.exercises.map((ex, i) => (
              <div key={ex.id} className="p-4 bg-white border border-slate-100 rounded-2xl shadow-sm space-y-3">
                <div className="flex justify-between items-center">
                  <span className="font-bold text-slate-800 text-sm">{ex.name}</span>
                  <button onClick={() => { const n = {...activeRoutine}; n.exercises.splice(i,1); setActiveRoutine(n); }} className="text-slate-300"><Trash2 size={14} /></button>
                </div>
                <div className="flex gap-2">
                  <div className="flex-1 bg-slate-50 p-2 rounded-xl text-center">
                    <span className="text-[8px] font-black text-slate-400 uppercase block">Rest</span>
                    <input type="number" value={ex.defaultPause} onChange={(e) => { const n={...activeRoutine}; n.exercises[i].defaultPause=parseInt(e.target.value); setActiveRoutine(n); }} className="bg-transparent font-bold text-center w-full outline-none text-xs" />
                  </div>
                  <div className="flex-1 bg-slate-50 p-2 rounded-xl text-center">
                    <span className="text-[8px] font-black text-slate-400 uppercase block">Sets</span>
                    <input type="number" value={ex.targetSets} onChange={(e) => { const n={...activeRoutine}; n.exercises[i].targetSets=parseInt(e.target.value); setActiveRoutine(n); }} className="bg-transparent font-bold text-center w-full outline-none text-xs" />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </main>
        <footer className="fixed bottom-0 left-0 right-0 p-5 bg-white border-t border-slate-100 pb-10 z-50">
          <button onClick={() => { setRoutines(routines.map(r => r.id === activeRoutine.id ? activeRoutine : r)); setView('home'); }} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-100">Save Changes</button>
        </footer>
      </div>
    );
  }

  if (view === 'active_workout') {
    const ex = activeRoutine.exercises[currentExerciseIndex];
    const logged = workoutLog[ex.id] || [];
    return (
      <div className="min-h-screen bg-white flex flex-col">
        <Header title={ex.name} subtitle={`Exercise ${currentExerciseIndex+1}/${activeRoutine.exercises.length}`} />
        <main className="p-6 flex-1 space-y-6">
          <div className="flex gap-3">
            <div className="flex-1 p-5 bg-slate-50 rounded-3xl text-center border border-slate-100">
              <span className="text-[10px] font-black text-slate-400 uppercase block mb-1">Weight</span>
              <input id="wi" type="number" step="0.5" defaultValue={logged.length > 0 ? logged[logged.length-1].weight : 0} className="text-3xl font-bold bg-transparent w-full text-center outline-none" />
            </div>
            <div className="flex-1 p-5 bg-slate-50 rounded-3xl text-center border border-slate-100">
              <span className="text-[10px] font-black text-slate-400 uppercase block mb-1">Reps</span>
              <input id="ri" type="number" defaultValue={logged.length > 0 ? logged[logged.length-1].reps : 10} className="text-3xl font-bold bg-transparent w-full text-center outline-none" />
            </div>
          </div>
          <button onClick={() => logSet(ex.id, document.getElementById('wi').value, document.getElementById('ri').value, ex.defaultPause)} className="w-full py-5 bg-slate-900 text-white rounded-[28px] font-bold text-lg active:scale-95 transition-transform">Log Set {logged.length + 1}</button>
          <div className="flex flex-wrap gap-2">
            {logged.map((s, i) => <div key={i} className="px-3 py-2 bg-blue-50 text-blue-600 rounded-xl text-[10px] font-bold border border-blue-100">SET {i+1}: {s.weight}kg Ã— {s.reps}</div>)}
          </div>
        </main>
        {timerActive && (
          <div className="fixed bottom-32 left-6 right-6 bg-slate-900 text-white p-4 rounded-2xl flex items-center justify-between animate-in fade-in slide-in-from-bottom-4">
            <div className="flex items-center gap-3 font-mono text-xl font-bold"><Clock className="text-blue-400" size={18} /> {Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2,'0')}</div>
            <button onClick={() => setTimerActive(false)} className="text-[10px] font-black uppercase tracking-tighter bg-white/10 px-3 py-1.5 rounded-lg">Skip Rest</button>
          </div>
        )}
        <footer className="fixed bottom-0 left-0 right-0 p-6 bg-white border-t border-slate-50 pb-10 flex gap-3">
          <button disabled={currentExerciseIndex === 0} onClick={() => setCurrentExerciseIndex(i => i-1)} className="w-14 h-14 bg-slate-50 rounded-xl flex items-center justify-center text-slate-300 disabled:opacity-20"><ChevronLeft/></button>
          <button onClick={() => currentExerciseIndex === activeRoutine.exercises.length-1 ? setView('home') : (setCurrentExerciseIndex(i=>i+1), setTimerActive(false))} className="flex-1 bg-slate-100 font-bold rounded-xl flex items-center justify-center gap-1">{currentExerciseIndex === activeRoutine.exercises.length-1 ? 'Done' : 'Next Exercise'} <ChevronRight size={18}/></button>
        </footer>
      </div>
    );
  }

  return null;
};

export default App;
